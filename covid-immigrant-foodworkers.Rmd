---
title: "covid-immigrant-foodworkers"
author: "Joe Yerardi"
date: "5/7/2020"
output: html_document
---

```{r setup, include = F}
# We want to hide the code and only see the results
knitr::opts_chunk$set(echo = F)

# We don't want to see any warnings from our code
knitr::opts_chunk$set(warning = F)

# We don't want to see any messages
knitr::opts_chunk$set(message = F)

# Set key file for the Census Bureau API key
key_file <- "key_file.txt"
```

```{r, include = F}
library(ipumsr)
library(labelled)
library(purrr)
library(rgdal)
library(sf)
library(tidycensus)
library(tidyverse)
library(tigris)
```

```{r import and format data}
# IPUMS (2014-18 ACS; population = 16 and older; employed - at work, employed - not at work)
ipums <- read.table("data/usa_00015.dat")
ddi <- read_ipums_ddi("data/usa_00015.xml")
ipums <- read_ipums_micro(ddi) %>% 
  mutate(state_code = as_factor(US2018C_ST, levels = "values"),
         state = as_factor(US2018C_ST, levels = "labels"),
         puma_code = paste0(state_code, as_factor(US2018C_PUMA)),
         industry_code = as_factor(US2018C_INDP, levels = "values"),
         industry = as_factor(US2018C_INDP, levels = "labels"),
         occupation_code =  as_factor(US2018C_OCCP, levels = "values"),
         occupation = as_factor(US2018C_OCCP, levels = "labels"),
         citizenship_code = as_factor(CITIZEN, levels = "values"),
         citizenship = as_factor(CITIZEN, levels = "labels"),
         ethnicity_code = as_factor(HISPAN, levels = "values"),
         ethnicity = as_factor(HISPAN, levels = "labels")) %>% 
  select(16:26, 5)

# PUMA shapefiles
pumas <- readOGR("data/ipums_puma_2010/ipums_puma_2010.shp") %>% 
  # Convert shapefile to sf object
  st_as_sf(crs = 5070, remove = F) %>% 
  select(puma_code = GEOID, puma = Name, geometry)

# County shapefiles
counties <- readOGR("data/tl_2019_us_county/tl_2019_us_county.shp") %>% 
  # Convert shapefile to sf object
  st_as_sf(crs = 5070, remove = F) %>% 
  select(county_code = GEOID, county = NAMELSAD, geometry)

# COVID county cases and deaths
covid <- read_csv("data/us-counties.csv",
                  col_types = cols(.default = "?", date = "D")) %>% 
  rename(county_code = fips) %>% 
  # Filter to the latest data for each county
  group_by(county_code) %>% 
  slice(which.max(date))

# County populations
# Read-in Census API key
census_key<- (readLines(key_file)[1])

# Create list of all US states to iterate through in the API calls
us <- unique(fips_codes$state)[1:51]

# Download population data from the 2014-2018 ACS
population <- map_df(us, function(x) {
  get_acs(geography = "county", variables = "B01001_001", 
          state = x, key = census_key)
}) %>% 
  mutate(income_quartile = ntile(estimate, 4)) %>% 
  select(county_code = GEOID,
         county = NAME,
         population = estimate)

# PUMA-to-county crosswalk
crosswalk <- read_csv("data/geocorr2018.csv", skip = 1) %>% 
  mutate(puma_code = paste0(`State code`, `PUMA (2012)`)) %>% 
  select(puma_code,
         county_code = `County code (2014)`,
         state = `State abbreviation`,
         county = `2014 county name`,
         puma = `PUMA12 name`,
         allocation_factor = `puma12 to county14 allocation factor`)
```

```{r join the covid, population and crosswalk data frames}
# Join the covid, population and crosswalk data frames
covid <- list(covid, population, crosswalk) %>% 
  reduce(inner_join, by = "county_code") %>% 
  mutate(puma = paste(puma, state.x, sep = " "),
         cases_per_100k = round(cases / population * 100000, digits = 0),
         deaths_per_100k = round(deaths / population * 100000, digits = 0)) %>% 
  select(1,
         state = state.x,
         county_code,
         county = county.y,
         puma_code,
         puma,
         population,
         cases,
         deaths,
         cases_per_100k,
         deaths_per_100k,
         allocation_factor)
```


```{r filter the industries}
# Filter to the food production industries we're interested in.
# Crop production; Animal production and aquaculture; Support activities for agriculture and forestry; Animal food; grain and oilseed milling; Sugar and confectionery products; Fruit and vegetable preserving and specialty food manufacturing; Dairy product manufacturing; Animal slaughtering and processing; Bakeries and tortilla manufacturing; except retail bakeries; Seafood and other miscellaneous foods; n.e.c.; Not specified food industries
food_production_industries <- list("0170", "0180", "0290", "1070", "1080", "1090", "1170", "1180", "1270", "1280", "1290")

ipums_food_production <- ipums %>% 
  filter(industry_code %in% food_production_industries)
```

```{r calculate employment by industry-occupation groupings}
# Calculate employment by citizenship.
citizenship_by_ind_occ <- ipums_food_production %>% 
  group_by(industry, occupation, citizenship_code) %>% 
  summarize(num_employees = sum(PERWT)) %>% 
  pivot_wider(id_cols = c(industry, occupation),
              names_from = c(citizenship_code),
              values_from = num_employees,
              names_prefix = "col_") %>% 
  replace(is.na(.), 0) %>% 
  mutate(native_citizen = col_0 + col_1,
         naturalized_citizen = col_2,
         non_citizen = col_3,
         total_employees = native_citizen + naturalized_citizen + non_citizen,
         native_citizen_pct = round(native_citizen / total_employees * 100, digits = 0),
         naturalized_citizen_pct = round(naturalized_citizen / total_employees * 100, digits = 0),
         non_citizen_pct = round(non_citizen / total_employees * 100, digits = 0)) %>% 
  select(industry,
         occupation,
         total_employees,
         native_citizen,
         naturalized_citizen,
         non_citizen,
         native_citizen_pct,
         naturalized_citizen_pct,
         non_citizen_pct)

# Calculate employment by citizenship and ethnicity.
citizenship_ethnicity_by_ind_occ <- ipums_food_production %>% 
  group_by(industry, occupation, citizenship_code, ethnicity_code) %>% 
  summarize(num_employees = sum(PERWT)) %>% 
  pivot_wider(id_cols = c(industry, occupation),
              names_from = c(citizenship_code, ethnicity_code),
              values_from = num_employees,
              names_prefix = "col_") %>% 
  replace(is.na(.), 0) %>% 
  mutate(native_citizen_non_hispanic = col_0_0 + col_1_0,
         native_citizen_hispanic = col_0_1 + col_0_2 + col_0_3 + col_0_4 + col_1_1 + col_1_2 + col_1_3 + col_1_4,
         naturalized_citizen_non_hispanic = col_2_0,
         naturalized_citizen_hispanic = col_2_1 + col_2_2 + col_2_3 + col_2_4,
         non_citizen_non_hispanic = col_3_0,
         non_citizen_hispanic = col_3_1 + col_3_2 + col_3_3 + col_3_4,
         total_employees = native_citizen_non_hispanic + native_citizen_hispanic + naturalized_citizen_non_hispanic + naturalized_citizen_hispanic + non_citizen_non_hispanic + non_citizen_hispanic,
         native_citizen_non_hispanic_pct = round(native_citizen_non_hispanic / total_employees * 100, digits = 0),
         native_citizen_hispanic_pct = round(native_citizen_hispanic / total_employees * 100, digits = 0),
         naturalized_citizen_non_hispanic_pct = round(naturalized_citizen_non_hispanic / total_employees * 100, digits = 0),
         naturalized_citizen_hispanic_pct = round(naturalized_citizen_hispanic / total_employees * 100, digits = 0),
         non_citizen_non_hispanic_pct = round(non_citizen_hispanic / total_employees * 100, digits = 0),
         non_citizen_hispanic_pct = round(non_citizen_hispanic / total_employees * 100, digits = 0)) %>% 
  select(industry,
         occupation,
         total_employees,
         native_citizen_non_hispanic,
         native_citizen_hispanic,
         naturalized_citizen_non_hispanic,
         naturalized_citizen_hispanic,
         non_citizen_non_hispanic,
         non_citizen_hispanic,
         native_citizen_non_hispanic_pct,
         native_citizen_hispanic_pct,
         naturalized_citizen_non_hispanic_pct,
         naturalized_citizen_hispanic_pct,
         non_citizen_non_hispanic_pct,
         non_citizen_hispanic_pct)
```

```{r filter the industry-occupation combinations}
# What is the non-native-born population of all employed people over the age of 16?
ipums %>% 
  group_by(citizenship) %>% 
  summarize(sum(PERWT))

# Non-native-born working-age employed population nationally = 17.1% (26,113,757)

# Select all industry-occupation combinations that have at least twice the foreign-born population of the country at large and at least 1,000 employees nationally.
high_immigrant_food_production_industries <- citizenship_by_ind_occ %>% 
  filter(total_employees >= 1000 & naturalized_citizen_pct + non_citizen_pct > 34)

# Exclude the occupations we've decided we're not interested in
excluded_occupations = list("CLN-Other Grounds Maintenance Workers",
                            "FFF-AGRICULTURAL INSPECTORS",
                            "MGR-Other Managers",
                            "OFF-Shipping, Receiving, And Inventory Clerks",
                            "CLN-MAIDS AND HOUSEKEEPING CLEANERS",
                            "OFF-WEIGHERS, MEASURERS, CHECKERS, AND SAMPLERS, RECORDKEEPING",
                            "TRN-CLEANERS OF VEHICLES AND EQUIPMENT")

high_immigrant_food_production_industries <- high_immigrant_food_production_industries %>% 
  filter(!occupation %in% excluded_occupations)

ipums_food_production <- ipums_food_production %>% 
  inner_join(high_immigrant_food_production_industries, by = c("industry", "occupation")) %>% 
  select(1:12)
```

```{r group the data}
# Group the data by citizenship plus industry, occupation and PUMA
citizenship_by_ind_occ_puma <- ipums_food_production %>% 
  group_by(puma_code, industry, industry_code, occupation, occupation_code, citizenship_code) %>% 
  summarize(num_employees = sum(PERWT)) %>% 
  pivot_wider(id_cols = c(puma_code, industry, industry_code, occupation, occupation_code),
              names_from = c(citizenship_code),
              values_from = num_employees,
              names_prefix = "col_") %>% 
  replace(is.na(.), 0) %>% 
  mutate(native_citizen = col_0 + col_1,
         total_foreign = col_2 + col_3,
         naturalized_citizen = col_2,
         non_citizen = col_3,
         total_employees = native_citizen + total_foreign,
         pct_native_citizen = round(native_citizen / total_employees * 100, digits = 0),
         pct_total_foreign = round(total_foreign / total_employees * 100, digits = 0),
         pct_naturalized_citizen = round(naturalized_citizen / total_employees * 100, digits = 0),
         pct_non_citizen = round(non_citizen / total_employees * 100, digits = 0)) %>% 
  select(puma_code,
         industry,
         industry_code,
         occupation,
         occupation_code,
         total_employees,
         native_citizen,
         total_foreign,
         naturalized_citizen,
         non_citizen,
         pct_native_citizen,
         pct_total_foreign,
         pct_naturalized_citizen,
         pct_non_citizen)

# Group the data by citizenship and ethnicity, plus industry, occupation and PUMA
citizenship_ethnicity_by_ind_occ_puma <- ipums_food_production %>% 
  group_by(puma_code, industry, industry_code, occupation, occupation_code, citizenship_code, ethnicity_code) %>% 
  summarize(num_employees = sum(PERWT)) %>% 
  pivot_wider(id_cols = c(puma_code, industry, industry_code, occupation, occupation_code),
              names_from = c(citizenship_code, ethnicity_code),
              values_from = num_employees,
              names_prefix = "col_") %>% 
  replace(is.na(.), 0) %>% 
  mutate(native_citizen_non_hispanic = col_0_0 + col_1_0,
         native_citizen_hispanic = col_0_1 + col_0_2 + col_0_3 + col_0_4 + col_1_1 + col_1_2 + col_1_3 + col_1_4,
         total_foreign_non_hispanic = col_2_0 + col_3_0,
         total_foreign_hispanic = col_2_1 + col_2_2 + col_2_3 + col_2_4 + col_3_1 + col_3_2 + col_3_3 + col_3_4,
         naturalized_citizen_non_hispanic = col_2_0,
         naturalized_citizen_hispanic = col_2_1 + col_2_2 + col_2_3 + col_2_4,
         non_citizen_non_hispanic = col_3_0,
         non_citizen_hispanic = col_3_1 + col_3_2 + col_3_3 + col_3_4,
         total_employees = native_citizen_non_hispanic + native_citizen_hispanic + total_foreign_non_hispanic + total_foreign_hispanic,
         pct_native_citizen_non_hispanic = round(native_citizen_non_hispanic / total_employees * 100, digits = 0),
         pct_native_citizen_hispanic = round(native_citizen_hispanic / total_employees * 100, digits = 0),
         pct_total_foreign_non_hispanic = round(total_foreign_non_hispanic / total_employees * 100, digits = 0),
         pct_total_foreign_hispanic = round(total_foreign_hispanic / total_employees * 100, digits = 0),
         pct_naturalized_citizen_non_hispanic = round(naturalized_citizen_non_hispanic / total_employees * 100, digits = 0),
         pct_naturalized_citizen_hispanic = round(naturalized_citizen_hispanic / total_employees * 100, digits = 0),
         pct_non_citizen_non_hispanic = round(non_citizen_hispanic / total_employees * 100, digits = 0),
         pct_non_citizen_hispanic = round(non_citizen_hispanic / total_employees * 100, digits = 0)) %>% 
  select(puma_code,
         industry,
         industry_code,
         occupation,
         occupation_code,
         native_citizen_non_hispanic,
         native_citizen_hispanic,
         total_foreign_non_hispanic,
         total_foreign_hispanic,
         naturalized_citizen_non_hispanic,
         naturalized_citizen_hispanic,
         non_citizen_non_hispanic,
         non_citizen_hispanic,
         pct_native_citizen_non_hispanic,
         pct_native_citizen_hispanic,
         pct_total_foreign_non_hispanic,
         pct_total_foreign_hispanic,
         pct_naturalized_citizen_non_hispanic,
         pct_naturalized_citizen_hispanic,
         pct_non_citizen_non_hispanic,
         pct_non_citizen_hispanic)

# Join the data
citizenship_ethnicity_by_ind_occ_puma <- citizenship_by_ind_occ_puma %>% 
  inner_join(citizenship_ethnicity_by_ind_occ_puma, by = c("puma_code",
                                                           "industry",
                                                           "industry_code",
                                                           "occupation",
                                                           "occupation_code"))

# Quick spot check
citizenship_ethnicity_by_ind_occ_puma %>% 
  filter(industry == "AGR-CROP PRODUCTION" & occupation == "FFF-Other Agricultural Workers") %>% 
  group_by(industry, occupation) %>% 
  summarize(sum(total_employees))

# Group the data only by PUMA
citizenship_ethnicity_by_puma <- citizenship_ethnicity_by_ind_occ_puma %>% 
  group_by(puma_code) %>% 
  summarize(native_citizen = sum(native_citizen),
            total_foreign = sum(total_foreign),
            naturalized_citizen = sum(naturalized_citizen),
            non_citizen = sum(non_citizen),
            total_employees = sum(total_employees),
            pct_native_citizen = round(native_citizen / total_employees * 100, digits = 0),
            pct_total_foreign = round(total_foreign / total_employees * 100, digits = 0),
            pct_naturalized_citizen = round(naturalized_citizen / total_employees * 100, digits = 0),
            pct_non_citizen = round(non_citizen / total_employees * 100, digits = 0),
                                    native_citizen_non_hispanic = sum(native_citizen_non_hispanic),
                                    native_citizen_hispanic = sum(native_citizen_hispanic),
                                    total_foreign_non_hispanic = sum(total_foreign_non_hispanic),
                                    total_foreign_hispanic = sum(total_foreign_hispanic),
                                    naturalized_citizen_non_hispanic = sum(naturalized_citizen_non_hispanic),
                                    naturalized_citizen_hispanic = sum(naturalized_citizen_hispanic),
                                    non_citizen_non_hispanic = sum(non_citizen_non_hispanic),
                                    non_citizen_hispanic = sum(non_citizen_hispanic),
                                    pct_native_citizen_non_hispanic = round(native_citizen_non_hispanic / total_employees * 100, digits = 0),
                                    pct_native_citizen_hispanic = round(native_citizen_hispanic / total_employees * 100, digits = 0),
                                    pct_total_foreign_non_hispanic = round(total_foreign_non_hispanic / total_employees * 100, digits = 0),
                                    pct_total_foreign_hispanic = round(total_foreign_hispanic / total_employees * 100, digits = 0),
                                    pct_naturalized_citizen_non_hispanic = round(naturalized_citizen_non_hispanic / total_employees * 100, digits = 0),
                                    pct_naturalized_citizen_hispanic = round(naturalized_citizen_hispanic / total_employees * 100, digits = 0),
                                    pct_non_citizen_non_hispanic = round(non_citizen_non_hispanic / total_employees * 100, digits = 0),
                                    pct_non_citizen_hispanic = round(non_citizen_hispanic / total_employees * 100, digits = 0)) %>% 
  select(1,
         6,
         2:5,
         7:26)

# Quick spot check
View(citizenship_ethnicity_by_puma %>% 
       filter(puma_code == "0605302"))
```

```{r analyze the data}
# What is the total number of workers employed in these industries?
sum(citizenship_ethnicity_by_ind_occ_puma$total_employees)

# What is the total number of foreigners employed in these industries?
sum(citizenship_ethnicity_by_ind_occ_puma$total_foreign)

# What is the total number of Hispanic foreigners employed in these industries?
sum(citizenship_ethnicity_by_ind_occ_puma$total_foreign_hispanic)

# Which PUMAs have the highest number of immigrant foodworkers?
citizenship_ethnicity_by_puma %>% 
  arrange(desc(total_foreign)) %>% 
  select(state, puma, total_employees, total_foreign, total_foreign_hispanic) %>% 
  head(23) # 2,294 PUMAs / 100 = 22.94

# And how many immigrant workers are in these PUMAs?
citizenship_ethnicity_by_puma %>% 
  arrange(desc(total_foreign)) %>% 
  select(puma, total_employees, total_foreign, total_foreign_hispanic) %>% 
  head(23) %>% 
  ungroup() %>% 
  summarize(sum(total_foreign)) # 2,294 PUMAs / 100 = 22.94

# And how many of these foreign-born workers are Hispanic?
citizenship_ethnicity_by_puma %>% 
  arrange(desc(total_foreign)) %>% 
  select(puma, total_employees, total_foreign, total_foreign_hispanic) %>% 
  head(23) %>% 
  ungroup() %>% 
  summarize(sum(total_foreign_hispanic)) # 2,294 PUMAs / 100 = 22.94

# What is the distribution of foreign workers in these industries by state?
foreign_foodworkers_by_state <- citizenship_ethnicity_by_puma %>% 
  group_by(state) %>% 
  summarize(state_total_employees = sum(total_employees),
            state_total_foreign = sum(total_foreign),
            state_pct_total_foreign = round(sum(total_foreign) / sum(total_employees) * 100), 2,
            state_total_foreign_hispanic = sum(total_foreign_hispanic),
            state_pct_total_foreign_hispanic = round(sum(total_foreign_hispanic) / sum(total_employees) * 100), 2) %>% 
  select(state, state_total_employees, state_total_foreign, state_pct_total_foreign, state_total_foreign_hispanic, state_pct_total_foreign_hispanic) %>% 
  arrange(desc(state_pct_total_foreign))
```

```{r}
write_csv(citizenship_by_ind_occ_puma %>% 
           group_by(industry, industry_code, occupation, occupation_code) %>% 
           distinct(industry, occupation, .keep_all = T) %>% 
           select(industry, industry_code, occupation, occupation_code),
         "data/exported/industry_occupation_pairs.csv")
```

```{r export the data}
# Export the data
st_write(foreign_foodworkers_by_state, "data/exported/foreign_foodworkers_by_state.csv")
st_write(citizenship_ethnicity_by_puma, "data/exported/citizenship_ethnicity_by_puma.geojson", driver = "GeoJSON")
st_write(citizenship_ethnicity_by_ind_occ_puma, "data/exported/citizenship_ethnicity_by_ind_occ_puma.geojson", driver = "GeoJSON")
st_write(citizenship_ethnicity_by_puma, "data/exported/citizenship_ethnicity_by_puma.csv")
st_write(citizenship_ethnicity_by_ind_occ_puma, "data/exported/citizenship_ethnicity_by_ind_occ_puma.csv")
```