---
title: "covid-immigrant-foodworkers"
author: "Joe Yerardi"
date: "5/7/2020"
output: html_document
---

```{r setup, include = F}
# We want to hide the code and only see the results
knitr::opts_chunk$set(echo = F)

# We don't want to see any warnings from our code
knitr::opts_chunk$set(warning = F)

# We don't want to see any messages
knitr::opts_chunk$set(message = F)
```

```{r, include = F}
library(ipumsr)
library(labelled)
library(rgdal)
library(sf)
library(tidyverse)
library(tigris)
```

```{r set working directory}
work_dir <- "C:/Users/joeye/Desktop/covid-immigrant-foodworkers"
setwd(work_dir)
```

```{r import data, include = F}
# IPUMS (2014-18 ACS; population = 16 and older; employed - at work, employed - not at work)
ipums_data <- read.table("data/usa_00014.dat")
ddi <- read_ipums_ddi("data/usa_00014.xml")
ipums_data <- read_ipums_micro(ddi)

# PUMAs
pumas <- readOGR("data/ipums_puma_2010/ipums_puma_2010.shp") %>% 
  # convert shapefile to sf object
  st_as_sf(crs = 5070, remove = F)
```

```{r clean data}
# Add factor type columns for relevant columns
ipums_data <- ipums_data %>% 
  mutate(industry_code = as_factor(US2018C_INDP, levels = "values"),
         industry = as_factor(US2018C_INDP, levels = "labels"),
         occupation_code =  as_factor(US2018C_OCCP, levels = "values"),
         occupation = as_factor(US2018C_OCCP, levels = "labels"),
         citizenship_code = as_factor(CITIZEN, levels = "values"),
         citizenship = as_factor(CITIZEN, levels = "labels"),
         ethnicity_code = as_factor(HISPAN, levels = "values"),
         ethnicity = as_factor(HISPAN, levels = "labels"),
         state_code = as_factor(US2018C_ST, levels = "values"),
         state = as_factor(US2018C_ST, levels = "labels"),
         puma_code = as_factor(US2018C_PUMA),
         state_puma_code = paste0(state_code, puma_code))

# Filter to just the columns we'll need
ipums_data_working <- ipums_data %>% 
  select(15, 30:37, 39, 41)

# Filter to the industries we're interested in.
food_worker_industries_list <- list("0170", "0180", "0290", "1070", "1080", "1090", "1170", "1180", "1270", "1280", "1290")

food_worker_industries <- ipums_data_working %>% 
  filter(industry_code %in% food_worker_industries_list)
```

```{r calculate employment by ind-occ groupings}
# Calculate employment by citizenship.
citizenship_by_ind_occ <- food_worker_industries %>% 
  group_by(industry, occupation, citizenship_code) %>% 
  summarize(num_employees = sum(PERWT)) %>% 
  pivot_wider(id_cols = c(industry, occupation),
              names_from = c(citizenship_code),
              values_from = num_employees,
              names_prefix = "col_") %>% 
  replace(is.na(.), 0) %>% 
  mutate(native_citizen = col_0 + col_1,
         naturalized_citizen = col_2,
         non_citizen = col_3,
         total_employees = native_citizen + naturalized_citizen + non_citizen,
         native_citizen_pct = round(native_citizen / total_employees * 100, digits = 0),
         naturalized_citizen_pct = round(naturalized_citizen / total_employees * 100, digits = 0),
         non_citizen_pct = round(non_citizen / total_employees * 100, digits = 0)) %>% 
  select(industry,
         occupation,
         total_employees,
         native_citizen,
         naturalized_citizen,
         non_citizen,
         native_citizen_pct,
         naturalized_citizen_pct,
         non_citizen_pct)

# Calculate employment by citizenship and ethnicity.
citizenship_ethnicity_by_ind_occ <- food_worker_industries %>% 
  group_by(industry, occupation, citizenship_code, ethnicity_code) %>% 
  summarize(num_employees = sum(PERWT)) %>% 
  pivot_wider(id_cols = c(industry, occupation),
              names_from = c(citizenship_code, ethnicity_code),
              values_from = num_employees,
              names_prefix = "col_") %>% 
  replace(is.na(.), 0) %>% 
  mutate(native_citizen_non_hispanic = col_0_0 + col_1_0,
         native_citizen_hispanic = col_0_1 + col_0_2 + col_0_3 + col_0_4 + col_1_1 + col_1_2 + col_1_3 + col_1_4,
         naturalized_citizen_non_hispanic = col_2_0,
         naturalized_citizen_hispanic = col_2_1 + col_2_2 + col_2_3 + col_2_4,
         non_citizen_non_hispanic = col_3_0,
         non_citizen_hispanic = col_3_1 + col_3_2 + col_3_3 + col_3_4,
         total_employees = native_citizen_non_hispanic + native_citizen_hispanic + naturalized_citizen_non_hispanic + naturalized_citizen_hispanic + non_citizen_non_hispanic + non_citizen_hispanic,
         native_citizen_non_hispanic_pct = round(native_citizen_non_hispanic / total_employees * 100, digits = 0),
         native_citizen_hispanic_pct = round(native_citizen_hispanic / total_employees * 100, digits = 0),
         naturalized_citizen_non_hispanic_pct = round(naturalized_citizen_non_hispanic / total_employees * 100, digits = 0),
         naturalized_citizen_hispanic_pct = round(naturalized_citizen_hispanic / total_employees * 100, digits = 0),
         non_citizen_non_hispanic_pct = round(non_citizen_hispanic / total_employees * 100, digits = 0),
         non_citizen_hispanic_pct = round(non_citizen_hispanic / total_employees * 100, digits = 0)) %>% 
  select(industry,
         occupation,
         total_employees,
         native_citizen_non_hispanic,
         native_citizen_hispanic,
         naturalized_citizen_non_hispanic,
         naturalized_citizen_hispanic,
         non_citizen_non_hispanic,
         non_citizen_hispanic,
         native_citizen_non_hispanic_pct,
         native_citizen_hispanic_pct,
         naturalized_citizen_non_hispanic_pct,
         naturalized_citizen_hispanic_pct,
         non_citizen_non_hispanic_pct,
         non_citizen_hispanic_pct)
```

```{r}
# What is the non-native-born population of all employed people over the age of 16?
View(ipums_data_working %>% 
       group_by(citizenship) %>% 
       summarize(sum(PERWT)))

# Non-native-born working-age employed population nationally = 17.1% (26,113,757)
```

```{r}
# Select all industry-occupation combinations that have at least twice the foreign-born population of the country at large and at least 1,000 employees nationally.
high_immigrant_industry_occupation_combos <- citizenship_by_ind_occ %>% 
  filter(total_employees >= 1000 & naturalized_citizen_pct + non_citizen_pct > 34)

# Exclude the occupations we've decided we're not interested in
excluded_occupations = list("CLN-Other Grounds Maintenance Workers",
                            "FFF-AGRICULTURAL INSPECTORS",
                            "MGR-Other Managers",
                            "OFF-Shipping, Receiving, And Inventory Clerks",
                            "CLN-MAIDS AND HOUSEKEEPING CLEANERS",
                            "OFF-WEIGHERS, MEASURERS, CHECKERS, AND SAMPLERS, RECORDKEEPING",
                            "TRN-CLEANERS OF VEHICLES AND EQUIPMENT")

# Exclude the occupations we've decided we're not interested in
high_immigrant_industry_occupation_combos <- high_immigrant_industry_occupation_combos %>% 
  filter(!occupation %in% excluded_occupations) %>% 
  arrange(total_employees)
```

```{r}
# Filter the data to just these combinations of industry-occupation.
high_immigrant_ind_occ_combos_records <- ipums_data_working %>% 
  inner_join(high_immigrant_industry_occupation_combos, by = c("industry", "occupation")) %>% 
  select(1:11)
```

```{r group the data}
# Group the data by citizenship, industry, occupation and PUMA
citizenship_by_ind_occ_puma <- high_immigrant_ind_occ_combos_records %>% 
  group_by(state, state_puma_code, industry, industry_code, occupation, occupation_code, citizenship_code) %>% 
  summarize(num_employees = sum(PERWT)) %>% 
  pivot_wider(id_cols = c(state, state_puma_code, industry, industry_code, occupation, occupation_code),
              names_from = c(citizenship_code),
              values_from = num_employees,
              names_prefix = "col_") %>% 
  replace(is.na(.), 0) %>% 
  mutate(native_citizen = col_0 + col_1,
         total_foreign = col_2 + col_3,
         naturalized_citizen = col_2,
         non_citizen = col_3,
         total_employees = native_citizen + total_foreign,
         pct_native_citizen = round(native_citizen / total_employees * 100, digits = 0),
         pct_total_foreign = round(total_foreign / total_employees * 100, digits = 0),
         pct_naturalized_citizen = round(naturalized_citizen / total_employees * 100, digits = 0),
         pct_non_citizen = round(non_citizen / total_employees * 100, digits = 0)) %>% 
  select(state,
         state_puma_code,
         industry,
         industry_code,
         occupation,
         occupation_code,
         total_employees,
         native_citizen,
         total_foreign,
         naturalized_citizen,
         non_citizen,
         pct_native_citizen,
         pct_total_foreign,
         pct_naturalized_citizen,
         pct_non_citizen)

# Group the data by citizenship, ethnicity, industry, occupation and PUMA
citizenship_ethnicity_by_ind_occ_puma <- high_immigrant_ind_occ_combos_records %>% 
group_by(state, state_puma_code, industry, industry_code, occupation, occupation_code, citizenship_code, ethnicity_code) %>% 
  summarize(num_employees = sum(PERWT)) %>% 
  pivot_wider(id_cols = c(state, state_puma_code, industry, industry_code, occupation, occupation_code),
              names_from = c(citizenship_code, ethnicity_code),
              values_from = num_employees,
              names_prefix = "col_") %>% 
  replace(is.na(.), 0) %>% 
  mutate(native_citizen_non_hispanic = col_0_0 + col_1_0,
         native_citizen_hispanic = col_0_1 + col_0_2 + col_0_3 + col_0_4 + col_1_1 + col_1_2 + col_1_3 + col_1_4,
         total_foreign_non_hispanic = col_2_0 + col_3_0,
         total_foreign_hispanic = col_2_1 + col_2_2 + col_2_3 + col_2_4 + col_3_1 + col_3_2 + col_3_3 + col_3_4,
         naturalized_citizen_non_hispanic = col_2_0,
         naturalized_citizen_hispanic = col_2_1 + col_2_2 + col_2_3 + col_2_4,
         non_citizen_non_hispanic = col_3_0,
         non_citizen_hispanic = col_3_1 + col_3_2 + col_3_3 + col_3_4,
         total_employees = native_citizen_non_hispanic + native_citizen_hispanic + total_foreign_non_hispanic + total_foreign_hispanic,
         pct_native_citizen_non_hispanic = round(native_citizen_non_hispanic / total_employees * 100, digits = 0),
         pct_native_citizen_hispanic = round(native_citizen_hispanic / total_employees * 100, digits = 0),
         pct_total_foreign_non_hispanic = round(total_foreign_non_hispanic / total_employees * 100, digits = 0),
         pct_total_foreign_hispanic = round(total_foreign_hispanic / total_employees * 100, digits = 0),
         pct_naturalized_citizen_non_hispanic = round(naturalized_citizen_non_hispanic / total_employees * 100, digits = 0),
         pct_naturalized_citizen_hispanic = round(naturalized_citizen_hispanic / total_employees * 100, digits = 0),
         pct_non_citizen_non_hispanic = round(non_citizen_hispanic / total_employees * 100, digits = 0),
         pct_non_citizen_hispanic = round(non_citizen_hispanic / total_employees * 100, digits = 0)) %>% 
  select(state,
         state_puma_code,
         industry,
         industry_code,
         occupation,
         occupation_code,
         native_citizen_non_hispanic,
         native_citizen_hispanic,
         total_foreign_non_hispanic,
         total_foreign_hispanic,
         naturalized_citizen_non_hispanic,
         naturalized_citizen_hispanic,
         non_citizen_non_hispanic,
         non_citizen_hispanic,
         pct_native_citizen_non_hispanic,
         pct_native_citizen_hispanic,
         pct_total_foreign_non_hispanic,
         pct_total_foreign_hispanic,
         pct_naturalized_citizen_non_hispanic,
         pct_naturalized_citizen_hispanic,
         pct_non_citizen_non_hispanic,
         pct_non_citizen_hispanic)

# Join the data
citizenship_ethnicity_by_ind_occ_puma <- citizenship_by_ind_occ_puma %>% 
  inner_join(citizenship_ethnicity_by_ind_occ_puma, by = c("state",
                                                           "state_puma_code",
                                                           "industry",
                                                           "industry_code",
                                                           "occupation",
                                                           "occupation_code"))

# How does it look?
View(citizenship_ethnicity_by_ind_occ_puma %>% 
       arrange(state, state_puma_code, industry, occupation))

# Quick spot check
View(citizenship_ethnicity_by_ind_occ_puma %>% 
       filter(industry == "AGR-CROP PRODUCTION" & occupation == "FFF-Other Agricultural Workers") %>% 
       group_by(industry, occupation) %>% 
       summarize(sum(total_employees)))
```

```{r group the data by PUMA}
# Group the data only by PUMA
citizenship_ethnicity_by_puma <- citizenship_ethnicity_by_ind_occ_puma %>% 
  group_by(state, state_puma_code) %>% 
  summarize(native_citizen = sum(native_citizen),
            total_foreign = sum(total_foreign),
            naturalized_citizen = sum(naturalized_citizen),
            non_citizen = sum(non_citizen),
            total_employees = sum(total_employees),
            pct_native_citizen = round(native_citizen / total_employees * 100, digits = 0),
            pct_total_foreign = round(total_foreign / total_employees * 100, digits = 0),
            pct_naturalized_citizen = round(naturalized_citizen / total_employees * 100, digits = 0),
            pct_non_citizen = round(non_citizen / total_employees * 100, digits = 0),
                                    native_citizen_non_hispanic = sum(native_citizen_non_hispanic),
                                    native_citizen_hispanic = sum(native_citizen_hispanic),
                                    total_foreign_non_hispanic = sum(total_foreign_non_hispanic),
                                    total_foreign_hispanic = sum(total_foreign_hispanic),
                                    naturalized_citizen_non_hispanic = sum(naturalized_citizen_non_hispanic),
                                    naturalized_citizen_hispanic = sum(naturalized_citizen_hispanic),
                                    non_citizen_non_hispanic = sum(non_citizen_non_hispanic),
                                    non_citizen_hispanic = sum(non_citizen_hispanic),
                                    pct_native_citizen_non_hispanic = round(native_citizen_non_hispanic / total_employees * 100, digits = 0),
                                    pct_native_citizen_hispanic = round(native_citizen_hispanic / total_employees * 100, digits = 0),
                                    pct_total_foreign_non_hispanic = round(total_foreign_non_hispanic / total_employees * 100, digits = 0),
                                    pct_total_foreign_hispanic = round(total_foreign_hispanic / total_employees * 100, digits = 0),
                                    pct_naturalized_citizen_non_hispanic = round(naturalized_citizen_non_hispanic / total_employees * 100, digits = 0),
                                    pct_naturalized_citizen_hispanic = round(naturalized_citizen_hispanic / total_employees * 100, digits = 0),
                                    pct_non_citizen_non_hispanic = round(non_citizen_non_hispanic / total_employees * 100, digits = 0),
                                    pct_non_citizen_hispanic = round(non_citizen_hispanic / total_employees * 100, digits = 0)) %>% 
  select(1:2,
         7,
         3:6,
         8:27)

# Join the citizenship ethnicity by ind occ puma dataframe  to the PUMAs
citizenship_ethnicity_by_ind_occ_puma <- inner_join(citizenship_ethnicity_by_ind_occ_puma, pumas, by = c("state_puma_code" = "GEOID")) %>% 
  mutate(puma = paste(Name, State, sep = ", ")) %>% 
  select(1,
         state_code = STATEFIP,
         puma,
         puma_code = state_puma_code,
         3:31,
         geometry)

# Join the citizenship ethnicity by puma dataframe to the PUMAs
citizenship_ethnicity_by_puma <- inner_join(citizenship_ethnicity_by_puma, pumas, by = c("state_puma_code" = "GEOID")) %>% 
  mutate(puma = paste(Name, State, sep = ", ")) %>% 
  select(1,
         state_code = STATEFIP,
         puma,
         puma_code = state_puma_code,
         3:27,
         34)

# Quick spot check
View(citizenship_ethnicity_by_puma %>% 
       filter(puma_code == "0605302"))

# Export the data
st_write(citizenship_ethnicity_by_puma, "data/exported/citizenship_ethnicity_by_puma.geojson", driver = "GeoJSON")
st_write(citizenship_ethnicity_by_ind_occ_puma, "data/exported/citizenship_ethnicity_by_ind_occ_puma.geojson", driver = "GeoJSON")
st_write(citizenship_ethnicity_by_puma, "data/exported/citizenship_ethnicity_by_puma.csv")
st_write(citizenship_ethnicity_by_ind_occ_puma, "data/exported/citizenship_ethnicity_by_ind_occ_puma.csv")
```